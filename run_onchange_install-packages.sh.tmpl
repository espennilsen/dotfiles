#!/usr/bin/env bash
set -e

# Symlink dotfiles CLI to PATH
mkdir -p "$HOME/.local/bin"
ln -sf "$(chezmoi source-path)/scripts/dotfiles" "$HOME/.local/bin/dotfiles"

# Install mise (version manager for node, pnpm, bun, etc.)
if ! command -v mise &> /dev/null; then
  curl https://mise.run | sh
fi

# Install default tools with mise
mise use -g node@lts
mise use -g pnpm@latest
mise use -g bun@latest
mise use -g go@latest
mise use -g python@latest
mise use -g rust@latest

{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "arch") }}

sudo pacman -S --noconfirm \
  git-lfs \
  gum \
  tmux \
  unzip \
  zip \
  neovim \
  less

# 1Password CLI (available in Chaotic AUR)
if ! command -v op &> /dev/null; then
  sudo pacman -S --noconfirm 1password-cli || echo "Install 1Password CLI manually: https://developer.1password.com/docs/cli/get-started/"
fi
{{- end }}

{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "ubuntu") }}

# Add 1Password CLI repo
if ! test -f /etc/apt/sources.list.d/1password.list; then
  sudo mkdir -p /etc/apt/keyrings
  curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor -o /etc/apt/keyrings/1password-archive-keyring.gpg
  echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main" | sudo tee /etc/apt/sources.list.d/1password.list
fi

# Add Charm repo for gum
if ! test -f /etc/apt/sources.list.d/charm.list; then
  sudo mkdir -p /etc/apt/keyrings
  curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
  echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
fi

sudo apt-get update
sudo apt-get install --yes \
  1password-cli \
  git-lfs \
  gum \
  tmux \
  jq \
  unzip \
  rng-tools \
  zip \
  neovim
{{- end }}

{{- if eq .chezmoi.os "darwin" }}

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

brew bundle --file=/dev/stdin <<EOF
# CLI tools
brew "git-lfs"
brew "tmux"
brew "jq"
brew "neovim"
brew "fd"
brew "gh"
brew "ripgrep"
brew "mise"
brew "powerlevel10k"
brew "fzf"
brew "htop"
brew "wget"
brew "yazi"
brew "zoxide"
brew "fastfetch"
brew "zsh-autosuggestions"
brew "zsh-syntax-highlighting"
brew "gum"
brew "nmap"
brew "iperf"
brew "cmake"
brew "websocat"
brew "watchman"
brew "pipx"
brew "cloudflared"
brew "gemini-cli"
# Dev tools
cask "powershell"
cask "ghostty"
cask "1password"
cask "1password-cli"
cask "cursor"
cask "docker-desktop"
cask "visual-studio-code@insiders"
cask "claude"
cask "lm-studio"
cask "raycast"
cask "postman"
cask "obs"
cask "devtoys"
cask "figma"

# Productivity
cask "obsidian"
cask "notion"

# Communication
cask "discord"
cask "telegram"
cask "whatsapp"
cask "spotify"

# Utilities
cask "vlc"
cask "the-unarchiver"
cask "bartender"
cask "balenaetcher"
cask "grandperspective"
cask "zerotier-one"
cask "rustdesk"
EOF
{{- end }}
